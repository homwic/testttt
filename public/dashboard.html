<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard | API Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      body {
        background: #f8f9fa;
      }
      .navbar-custom {
        background-color: #007bff;
        color: white;
      }
      .navbar-custom .navbar-brand {
        color: white;
      }
      .navbar-custom .btn-danger {
        background-color: #e3342f;
        color: white;
      }
      .card {
        border-radius: 1rem;
      }
      .apikey-box {
        font-family: monospace;
        background: #e9ecef;
        padding: 7px 15px;
        border-radius: 7px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 7px;
      }
      .apikey-value {
        word-break: break-all;
        font-size: 1rem;
      }
      .copy-btn {
        border: none;
        background: none;
        color: #007bff;
        padding: 0 3px;
        font-size: 1.17rem;
        cursor: pointer;
        transition: color 0.18s;
        outline: none;
        margin-left: 8px;
        margin-right: -5px;
        display: flex;
        align-items: center;
      }
      .copy-btn:active,
      .copy-btn:focus {
        color: #004080;
      }
      .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.25rem rgba(38, 143, 255, 0.5);
      }
      .whitelist-box {
        padding: 1.25rem;
        background: #f8f9fa;
        border-radius: 1rem;
      }
      .btn-custom {
        background-color: #007bff;
        color: white;
        width: 100%;
      }
      .btn-custom:hover {
        background-color: #0056b3;
      }
      .list-group-item {
        border: none;
      }
      .pay-bank-img {
        height: 36px;
        width: auto;
        margin-right: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 5px #0002;
        background: #fff;
      }
      .pay-icon-fallback {
        font-size: 2.1rem;
        color: #555;
        margin-right: 10px;
      }
      @media (max-width: 700px) {
        .whitelist-box,
        .card {
          padding: 0.7rem;
        }
      }
      @media (max-width: 430px) {
        .pay-bank-img {
          height: 28px !important;
        }
        .pay-icon-fallback {
          font-size: 1.4rem !important;
        }
        .apikey-value {
          font-size: 0.96rem;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-custom mb-4">
      <div class="container">
        <a class="navbar-brand fw-bold" href="#">
          <i class="bi bi-code-slash"></i> API Demo
        </a>
        <div class="ms-auto">
          <a href="profile.html" class="btn btn-info me-2"
            ><i class="bi bi-person-circle"></i> Profile</a
          >
          <button class="btn btn-danger" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row">
        <!-- Whitelist (IP/Domain) -->
        <div class="col-md-4">
          <div class="card mb-4 whitelist-box">
            <div class="card-body">
              <h5>
                <i class="bi bi-shield-check text-success"></i> Whitelist
                (IP/Domain)
              </h5>
              <ul id="whitelistList" class="list-group mb-3"></ul>
              <form id="wlForm" class="d-flex">
                <input
                  type="text"
                  class="form-control me-2"
                  placeholder="IP/domain..."
                  id="wlItem"
                  required
                />
                <button class="btn btn-success" type="submit">
                  <i class="bi bi-plus-circle"></i> Add
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- API Key and Expiry Date -->
        <div class="col-md-8">
          <div class="card mb-4">
            <div class="card-body">
              <h3 class="mb-3">
                <i class="bi bi-key"></i> API Key Information
              </h3>
              <table class="table table-striped">
                <tbody id="apiKeyTable"></tbody>
              </table>
              <div id="apiBtnSection"></div>
            </div>
          </div>
        </div>
      </div>

      <hr />

      <h4 class="mt-4 mb-2"><i class="bi bi-terminal"></i> Test API Proxy</h4>
      <button class="btn btn-info mb-2" onclick="testApi()">
        <i class="bi bi-lightning-charge"></i> Coba Proxy (pakai API key &
        whitelist!)
      </button>
      <pre id="apiTestResult" class="mt-3"></pre>
    </div>

    <!-- Toast Notifications -->
    <div
      class="toast-container position-fixed bottom-0 end-0 p-3"
      id="toastContainer"
      aria-live="assertive"
      aria-atomic="true"
    >
      <div
        id="toast"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto" id="toastTitle">Notification</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div class="toast-body" id="toastMessage">Your message goes here.</div>
      </div>
    </div>

    <!-- MODAL METODE PEMBAYARAN -->
    <div
      class="modal fade"
      id="paymentModal"
      tabindex="-1"
      aria-labelledby="paymentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <form id="paymentForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="paymentModalLabel">
              <i class="bi bi-credit-card"></i> Pilih Metode Pembayaran
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Tutup"
            ></button>
          </div>
          <div class="modal-body">
            <!-- BCA VA -->
            <div class="form-check mb-3 d-flex align-items-center">
              <input
                class="form-check-input me-2"
                type="radio"
                name="method"
                id="BCAVA"
                value="BCAVA"
                checked
              />
              <label
                class="form-check-label d-flex align-items-center w-100"
                for="BCAVA"
              >
                <img
                  src="image/bca.png"
                  alt="BCA"
                  class="pay-bank-img"
                  onerror="this.style.display='none';this.parentNode.querySelector('.bi-bank2').style.display='inline-block';"
                />
                <i
                  class="bi bi-bank2 pay-icon-fallback"
                  style="display: none"
                ></i>
                <span>BCA Virtual Account</span>
              </label>
            </div>
            <!-- BNI VA -->
            <div class="form-check mb-3 d-flex align-items-center">
              <input
                class="form-check-input me-2"
                type="radio"
                name="method"
                id="BNIVA"
                value="BNIVA"
              />
              <label
                class="form-check-label d-flex align-items-center w-100"
                for="BNIVA"
              >
                <img
                  src="image/bni.png"
                  alt="BNI"
                  class="pay-bank-img"
                  style="height: 12px"
                  onerror="this.style.display='none';this.parentNode.querySelector('.bi-bank').style.display='inline-block';"
                />
                <i
                  class="bi bi-bank pay-icon-fallback"
                  style="display: none"
                ></i>
                <span>BNI Virtual Account</span>
              </label>
            </div>
            <!-- BRI VA -->
            <div class="form-check mb-3 d-flex align-items-center">
              <input
                class="form-check-input me-2"
                type="radio"
                name="method"
                id="BRIVA"
                value="BRIVA"
              />
              <label
                class="form-check-label d-flex align-items-center w-100"
                for="BRIVA"
              >
                <img
                  src="image/bri.png"
                  alt="BRI"
                  class="pay-bank-img"
                  style="height: 12px"
                  onerror="this.style.display='none';this.parentNode.querySelector('.bi-cash-coin').style.display='inline-block';"
                />
                <i
                  class="bi bi-cash-coin pay-icon-fallback"
                  style="display: none"
                ></i>
                <span>BRI Virtual Account</span>
              </label>
            </div>
            <!-- QRIS -->
            <div class="form-check mb-2 d-flex align-items-center">
              <input
                class="form-check-input me-2"
                type="radio"
                name="method"
                id="QRIS"
                value="QRIS"
              />
              <label
                class="form-check-label d-flex align-items-center w-100"
                for="QRIS"
              >
                <img
                  src="image/qris.png"
                  alt="QRIS"
                  class="pay-bank-img"
                  style="height: 12px"
                  onerror="this.style.display='none';this.parentNode.querySelector('.bi-qr-code').style.display='inline-block';"
                />
                <i
                  class="bi bi-qr-code pay-icon-fallback"
                  style="display: none"
                ></i>
                <span>QRIS (All E-Wallet/Bank)</span>
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-arrow-right-circle"></i> Lanjut ke Pembayaran
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      if (!localStorage.getItem("token")) location = "index.html";
      let user;

      async function loadUser() {
        const resp = await fetch("/api/me", {
          headers: { Authorization: "Bearer " + localStorage.getItem("token") },
        });
        const data = await resp.json();
        if (data.status !== "ok") return logout();
        user = data.user;
        updateWhitelist();
        renderApiKeyInfo();
        renderApiBtnSection();
      }

      function logout() {
        localStorage.removeItem("token");
        window.location = "index.html";
      }

      async function updateWhitelist() {
        if (!user) return;
        const list = user.whitelist || [];
        let html = "";
        list.forEach((item) => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="bi bi-globe"></i> ${item}</span>
            <button class="btn btn-sm btn-danger" onclick="delWhitelist('${item}')"><i class="bi bi-trash"></i> Hapus</button>
          </li>`;
        });
        document.getElementById("whitelistList").innerHTML = html;
      }

      document.getElementById("wlForm").onsubmit = async function (e) {
        e.preventDefault();
        const item = document.getElementById("wlItem").value;
        const resp = await fetch("/api/whitelist/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
          body: JSON.stringify({ item }),
        });
        const data = await resp.json();
        if (data.status === "ok") {
          user.whitelist = data.whitelist;
          updateWhitelist();
          document.getElementById("wlItem").value = "";
          showToast("Berhasil menambahkan IP/Domain ke whitelist.", "success");
        } else {
          showToast(data.message, "danger");
        }
      };

      async function delWhitelist(item) {
        if (!confirm("Hapus?")) return;
        const resp = await fetch("/api/whitelist/delete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
          body: JSON.stringify({ item }),
        });
        const data = await resp.json();
        if (data.status === "ok") {
          user.whitelist = data.whitelist;
          updateWhitelist();
          showToast("IP/Domain berhasil dihapus dari whitelist.", "success");
        } else {
          showToast(data.message, "danger");
        }
      }

      async function testApi() {
        if (!user.apiKey) return showToast("API Key belum aktif!", "danger");
        let params = `username=test&domain=test.com&password=123&paket=1&apikey=${user.apiKey}`;
        const resp = await fetch("/api/proxy?" + params);
        const data = await resp.json();
        document.getElementById("apiTestResult").textContent = JSON.stringify(
          data,
          null,
          2
        );
      }

      // BAGIAN API KEY + COPY DI POJOK KANAN
      function renderApiKeyInfo() {
        const apiKeyDiv = document.getElementById("apiKeyTable");
        if (user.apiKey && user.apiKeyExpired) {
          apiKeyDiv.innerHTML = `
            <tr>
              <th>API Key</th>
              <td>
                <div class="apikey-box justify-content-between">
                  <span class="apikey-value" id="apiKeyValue">${user.apiKey}</span>
                  <button class="copy-btn" id="copyApiKeyBtn" title="Salin API Key">
                    <i class="bi bi-clipboard"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr>
              <th>Expired</th>
              <td><i class="bi bi-calendar-x"></i> ${new Date(user.apiKeyExpired).toLocaleString()}</td>
            </tr>
          `;
          setTimeout(() => {
            document.getElementById("copyApiKeyBtn").onclick = copyApiKey;
          }, 50);
        } else {
          apiKeyDiv.innerHTML = `
            <tr><th>API Key</th><td>-</td></tr>
            <tr><th>Expired</th><td>-</td></tr>
          `;
        }
      }

      function copyApiKey() {
        const apiKey = document.getElementById("apiKeyValue").innerText;
        navigator.clipboard.writeText(apiKey);
        const btn = document.getElementById("copyApiKeyBtn");
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-lg text-success"></i>';
        btn.disabled = true;
        showToast("API Key berhasil disalin!", "success");
        setTimeout(() => {
          btn.innerHTML = '<i class="bi bi-clipboard"></i>';
          btn.disabled = false;
        }, 1200);
      }

      // SECTION BUTTONS: Payment, Perpanjang, Generate
      function renderApiBtnSection() {
        const container = document.getElementById("apiBtnSection");
        let expired = user.apiKeyExpired
          ? new Date(user.apiKeyExpired) < new Date()
          : true;

        if (!user.apiKey || expired) {
          container.innerHTML = `
            <button class="btn btn-primary w-100 mb-2" id="payApiBtn">
              <i class="bi bi-wallet2"></i> Berlangganan API
            </button>
          `;
          document.getElementById("payApiBtn").onclick = showPaymentModal;
        } else {
          container.innerHTML = `
            <button class="btn btn-warning w-100 mb-2" id="generateApiKeyBtn">
              <i class="bi bi-arrow-repeat"></i> Generate New API Key
            </button>
            <button class="btn btn-success w-100" id="renewApiBtn">
              <i class="bi bi-arrow-up-right-circle"></i> Perpanjang API
            </button>
          `;
          document.getElementById("generateApiKeyBtn").onclick = generateApiKey;
          document.getElementById("renewApiBtn").onclick = showPaymentModal;
        }
      }

      // Generate API Key
      async function generateApiKey() {
        const resp = await fetch("/api/generate-api-key", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
        });
        const data = await resp.json();
        if (data.status === "ok") {
          user.apiKey = data.apiKey;
          user.apiKeyExpired = data.apiKeyExpired;
          renderApiKeyInfo();
          showToast("API Key berhasil digenerate!", "success");
        } else {
          showToast(data.message, "danger");
        }
      }

      // TAMPILKAN MODAL PEMBAYARAN
      function showPaymentModal() {
        var modal = new bootstrap.Modal(
          document.getElementById("paymentModal")
        );
        modal.show();
      }

      // Submit pembayaran (buat invoice)
      document.getElementById("paymentForm").onsubmit = async function (e) {
        e.preventDefault();
        const method = document.querySelector(
          'input[name="method"]:checked'
        ).value;
        showToast("Membuat invoice...", "info");
        const resp = await fetch("/api/pay", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
          body: JSON.stringify({ method }),
        });
        const data = await resp.json();
        if (data.status === "ok" && data.payment_url) {
          showToast("Mengalihkan ke pembayaran...", "success");
          bootstrap.Modal.getInstance(
            document.getElementById("paymentModal")
          ).hide();
          setTimeout(() => {
            window.location = data.payment_url;
          }, 900);
        } else {
          showToast(data.message, "danger");
        }
      };

      // Show toast notification
      function showToast(message, type) {
        const toastTitle = document.getElementById("toastTitle");
        const toastMessage = document.getElementById("toastMessage");
        if (type === "success") toastTitle.textContent = "Success";
        else if (type === "info") toastTitle.textContent = "Info";
        else toastTitle.textContent = "Error";
        toastMessage.textContent = message;

        const toast = new bootstrap.Toast(document.getElementById("toast"));
        toast.show();
      }

      loadUser();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
